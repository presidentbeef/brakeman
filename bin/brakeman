#!/usr/bin/env ruby
#Adjust path in case called directly and not through gem
$:.unshift "#{File.expand_path(File.dirname(__FILE__))}/../lib"

require 'brakeman'
require 'brakeman/options'
require 'brakeman/version'

#Parse options
begin
  options, parser = Brakeman::Options.parse! ARGV
rescue OptionParser::ParseError => e
  $stderr.puts e.message
  $stderr.puts "Please see `brakeman --help` for valid options"
  exit(-1)
end

#Exit early for these options
if options[:list_checks] or options[:list_optional_checks]
  Brakeman.list_checks options
  exit
elsif options[:create_config]
  Brakeman.dump_config options
  exit
elsif options[:show_help]
  puts parser
  exit
elsif options[:show_version]
  puts "brakeman #{Brakeman::Version}"
  exit
end

#Set application path according to the commandline arguments
unless options[:app_path]
  if ARGV[-1].nil?
    options[:app_path] = "."
  else
    options[:app_path] = ARGV[-1]
  end
end

options = Brakeman.default_options.merge(Brakeman.load_options(options)).merge(options)

trap("INT") do
  $stderr.puts "\nInterrupted - exiting."

  if options[:debug]
    $stderr.puts caller
  end

  exit!
end

if options[:quiet].nil?
  options[:quiet] = :command_line
end

begin
  if options[:ensure_latest]
    if error = Brakeman.ensure_latest
      warn error
      exit Brakeman::Not_Latest_Version_Exit_Code
    end
  end

  if options[:previous_results_json]
    require 'json'
    vulns = Brakeman.compare options.merge(:quiet => options[:quiet])

    if options[:comparison_output_file]
      File.open options[:comparison_output_file], "w" do |f|
        f.puts JSON.pretty_generate(vulns)
      end

      Brakeman.notify "Comparison saved in '#{options[:comparison_output_file]}'"
    else
      puts JSON.pretty_generate(vulns)
    end

    if options[:exit_on_warn] && vulns[:new].count > 0
      exit Brakeman::Warnings_Found_Exit_Code
    end
  else
    #Run scan and output a report
    tracker = Brakeman.run options.merge(:print_report => true, :quiet => options[:quiet])

    #Return error code if --exit-on-warn is used and warnings were found
    if tracker.options[:exit_on_warn] and not tracker.filtered_warnings.empty?
      exit Brakeman::Warnings_Found_Exit_Code
    end

    #Return error code if --exit-on-error is used and errors were found
    if tracker.options[:exit_on_error] and tracker.errors.any?
      exit Brakeman::Errors_Found_Exit_Code
    end
  end

rescue Brakeman::NoApplication => e
  warn e.message
  exit Brakeman::No_App_Found_Exit_Code
rescue Brakeman::MissingChecksError => e
  warn e.message
  exit Brakeman::Missing_Checks_Exit_Code
end

#!/usr/bin/env ruby
$:.unshift "#{File.expand_path(File.dirname(__FILE__))}/../lib"

require "json"
require "shellwords"

if File.exist?("/config.json")
  engine_config = JSON.parse(File.read("/config.json"))
else
  engine_config = {}
end

command = "/usr/src/app/bin/brakeman --quiet --format codeclimate"

debug = engine_config["config"] && engine_config["config"]["debug"]

# ATM this gets parsed as a string instead of bool: "config":{ "debug":"true" }
if debug && debug.to_s.downcase == "true"
  command << " --debug --no-progress"
end

IncompatibleFilenameError = Class.new(StandardError)

if engine_config["include_paths"]
  paths = engine_config["include_paths"].compact.select do |path|
    if path.include?(",")
      raise IncompatibleFilenameError, "Can't analyze #{path.inspect} because it has a comma in its filename. Please remove this file or exclude it in your .codeclimate.yml"
    else
      path
    end
  end
  command << " --only-files #{paths.join(",").shellescape}"
end

if system("test -w /dev/stdout")
  command << " --output /dev/stdout"
end

exec command
